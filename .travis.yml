# We set the language to c because python isn't supported on the MacOS X nodes
# on Travis. However, the language ends up being irrelevant anyway, since we
# install Python ourselves using conda.
language: c

compiler: gcc

# Cache can be cleared from the travis settings menu, see docs currently at
# https://docs.travis-ci.com/user/caching#Clearing-Caches
cache:
  - ccache

os:
    - linux

stage: Comprehensive tests

# Setting sudo to false opts in to Travis-CI container-based builds.
sudo: false

# tzdata is included to ensure system leap seconds are up to date.
addons:
    apt:
        packages:
            - language-pack-de
            - tzdata

env:
    global:
        # Set defaults to avoid repeating in most cases
        - USE_CI_HELPERS=False
        - SETUP_XVFB=True
        - TOXENV='test'
        - TOXARGS=''
        - TOXPOSARGS=''
        # - EVENT_TYPE='push pull_request'
        # Run test suite twice in a row without cleaning
        # - DOUBLE_PLAY=False

stages:
   # Do the style check and a single test job, don't proceed if it fails
   - name: Initial tests
   # Do the rest of the tests
   - name: Comprehensive tests
   - name: Final tests
   - name: Cron tests
    #  if: type = cron

matrix:

    # Don't wait for allowed failures
    fast_finish: true

    include:

        - language: python
          python: 3.6
          stage: Initial tests
          env: TOXENV="test-all"
               TOXPOSARGS="--durations=50""
          compiler: clang

before_install:

    # We need a full clone to make sure setuptools_scm works properly
    - git fetch --unshallow .
    - git fetch --depth=1000000

    # We need to use CCOMPILER otherwise Travis overwrites CC if we define it
    # in env: above.
    - if [ ! -z $CCOMPILER ]; then
        export CC=$CCOMPILER;
      fi

     # Check CC variable
    - echo $CC

    # Write configuration items to standard location to make sure they are
    # ignored (the tests will fail if not)
    - mkdir -p $HOME/.astropy/config/
    - printf "unicode_output = True\nmax_width = 500" > $HOME/.astropy/config/astropy.cfg


install:
    - if [[ $USE_CI_HELPERS == True ]]; then
        git clone git://github.com/astropy/ci-helpers.git;
        source ci-helpers/travis/setup_conda.sh;
      fi

script:
    - pip install tox tox-pypi-filter --upgrade
    - tox -e $TOXENV $TOXARGS -- $TOXPOSARGS

after_success:
    - pip install codecov
    - codecov --gcov-glob "*cextern*";
